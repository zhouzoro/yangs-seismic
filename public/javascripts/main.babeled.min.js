"use strict";function initRefe(){var t=new Vue({el:"#app-r",data:{refes:[]},methods:{remove:function(t){t.abort(),this.refes.$remove(t)}}}),e=initManeger();$("#btn-add").click(function(){t.refes.push(e.addAtt())}),$("#btn-upload").click(function(){$("#loader").modal("show");var e=$("#loader").find(".loader"),i=function(i){e.text("uploading "+i+"of "+t.refes.length)};_.forEach(t.refes,function(e,o){o++,i(o),console.log(e);var n={index:e.index,title:e.title,name:e.name,txt:e.txt,source:e.source,path:e.path};$.post("/add_publication",n,function(e){console.log(e),$("#loader").modal("hide"),o==t.refes.length&&document.location.reload(!0)})}),$("#loader").modal("hide"),document.location.reload(!0)})}function uploadLogo(){var t=$(this).next("img"),e=$("<input>").attr({type:"file","class":"temp-input"}).css({display:"none",position:"absolute"}).change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){t.attr("src",e.target.result)},e.readAsDataURL(this.files[0]);var i=new XMLHttpRequest;i.withCredentials=!1,i.open("POST","/logo");var o=new FormData;o.append("file",this.files[0],this.files[0].name),i.send(o)}});$("body").append(e),e.click()}function contentAnimate(){$(".content-module").each(function(t,e){checkVisible(e)&&!$(e).hasClass("already-visible")?($(e).addClass("already-visible"),"down"===scrollStatus.direction?$(e).removeClass("not-visible").addClass("come-in"):$(e).removeClass("not-visible").addClass("come-down")):checkVisible(e)||$(e).removeClass("already-visible come-in come-down").addClass("not-visible")})}function changeHeaderOrNot(){$(window).width()<1e3?(controlNavPosition(),$(document).on("scroll",controlNavPosition)):$(document).off("scroll",controlNavPosition)}function toggleSidebar(){$(".sidebar").sidebar("toggle")}function ScrollTop(){var t=$("html, body");t.stop().animate({scrollTop:0},"500")}function showScrollTop(){checkVisible($("#top-indicator"))?($("#vertical-nv").removeClass("pinned").addClass("normal"),$("#scroll-top").removeClass("in").addClass("out")):($("#vertical-nv").removeClass("normal").addClass("pinned"),$("#scroll-top").removeClass("out").addClass("in"))}function controlNavPosition(t){checkVisible($("#top-indicator"))?$("#header").removeClass("fixed-header").addClass("normal"):($("#header").removeClass("normal").addClass("fixed-header"),"up"===scrollStatus.direction&&scrollStatus.continuous===!0?$("#header").removeClass("hidden").addClass("shown"):"down"===scrollStatus.direction&&scrollStatus.continuous===!0&&$("#header").removeClass("shown").addClass("hidden"))}function checkVisible(t,e){e=e||"visible";var i=$(window).height(),o=$(window).scrollTop(),n=$(t).offset().top,a=$(t).height();return"visible"===e?i+o>n&&n>o-a:"above"===e?i+o>n:void 0}function scrollTo(t){var e=$("html, body");e.stop().animate({scrollTop:$(t).offset().top},"500")}function initMce(t,e){var i=!1;e&&(i=!0),tinymce.EditorManager.remove(),tinymce.init({selector:t,skin:"mymce1",language:"zh_CN",content_css:"/stylesheets/mce.min.css",inline:i,plugins:"table contextmenu autoresize contextmenu paste image imagetools preview",style_formats:[{title:"H1",block:"h1"},{title:"H2",block:"h2"},{title:"H3",block:"h3"},{title:"Bold text",inline:"strong"},{title:"Red text",inline:"span",styles:{color:"#ff0000"}},{title:"Red header",block:"h1",styles:{color:"#ff0000"}},{title:"Badge",inline:"span",styles:{display:"inline-block",border:"1px solid #2276d2","border-radius":"5px",padding:"2px 5px",margin:"0 2px",color:"#2276d2"}},{title:"Table row 1",selector:"tr",classes:"tablerow1"}],formats:{alignleft:{selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img",classes:"left"},aligncenter:{selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img",classes:"center"},alignright:{selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img",classes:"right"},alignfull:{selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img",classes:"full"},bold:{inline:"span",classes:"bold"},italic:{inline:"span",classes:"italic"},underline:{inline:"span",classes:"underline",exact:!0},strikethrough:{inline:"del"},customformat:{inline:"span",styles:{color:"#00ff00",fontSize:"20px"},attributes:{title:"My custom format"},classes:"example1"}},toolbar:"formatselect fontsizeselect bold italic underline strikethrough alignleft aligncenter alignright alignfull advlist lists link image preview",image_caption:!0,paste_data_images:!0,fontsize_formats:"8pt 9pt 10pt 11pt 12pt 14pt 18pt 24pt",contextmenu:"formatselect bold italic link image inserttable | cell row column deletetable",menubar:!1,images_upload_url:"/images",statusbar:!1})}function uploadPic(){var t=$(this).next("img"),e=$(this).find("#pic-loader"),i=$(this).find("label"),o=$("<input>").attr({type:"file","class":"temp-input"}).css({display:"none",position:"absolute"}).change(function(){if(this.files&&this.files[0]){var o=new FileReader;o.onload=function(e){t.attr("src",e.target.result)},o.readAsDataURL(this.files[0]),i.removeClass("btn").addClass("pct");var n=function(t){var o=Math.ceil(100*t.loaded/t.total),n=100-o;e.css({height:n+"px"}),i.text(o+"%")},a=new XMLHttpRequest;a.withCredentials=!1,a.open("POST","/images"),a.onload=function(){var e=JSON.parse(a.responseText);console.log(e.location),t.attr("src",e.location),i.removeClass("pct").addClass("btn").text("change"),$(".temp-input").remove()},a.upload.addEventListener("progress",n,!1);var l=new FormData;l.append("image",this.files[0],this.files[0].name),a.send(l)}});$("body").append(o),o.click()}function computProgress(t){var e=Math.ceil(1e3*t.loaded/t.total)/10+"%";return e}function Att(){var t=this;this.index=0,this.txt="",this.name="",this.source="",this.path="",this.progress="0%",this.updateProgress=function(e){t.progress=computProgress(e)};var e=new XMLHttpRequest;e.withCredentials=!1,e.open("POST","/files"),e.onload=function(){var i=JSON.parse(e.responseText);t.path=i.location},e.upload.addEventListener("progress",this.updateProgress,!1),this.uploadFile=function(){var i=$("<input>").attr({type:"file","class":"temp-input"}).css({display:"none",position:"absolute"}).change(function(){if(this.files&&this.files[0]){var i=new FormData;t.name=this.files[0].name,i.append("file",this.files[0],this.files[0].name),e.onload=function(){var i=JSON.parse(e.responseText);t.path=i.location},e.send(i)}});$("body").append(i),i.click()},this.abort=function(){e.abort()}}function initManeger(){var t={atts:{}},e=0;return t.addAtt=function(){e++;var i="att"+e,o=new Att;return o.uploadFile(),t.atts[i]=o,o},t.wrapUp=function(t){var e="";return _.forEach(t,function(t,i){i++,e+="<p>附件."+i+'： <a href="'+t.path+'" download="'+t.name+'">'+t.name+"</a></p>"}),e},t}function initUploadOf(t,e){if(initMce("#input-body",e),"people"===t)console.log("uploading type of "+t),$("#btn-upload").click(function(){$("#loader").modal("show");var t=$("#upload-people"),i={name:t.find("#input-name").val(),picture:t.find("#profile-pic").find("img").attr("src"),title:t.find("#input-title").val(),degree:t.find("#input-degree").val(),office:t.find("#input-office").val(),email:t.find("#input-email").val(),phone:t.find("#input-phone").val(),details:tinymce.activeEditor.save()};e&&(i.id=e),$.post("/add_people",i,function(t){e?document.location.reload(!0):window.location=t.url})});else{var i=initManeger(),o=new Vue({el:"#app",data:{atts:[]},methods:{remove:function(t){t.abort(),this.atts.$remove(t)}}});$("#btn-img").click(function(){var t=$("<input>").attr({type:"file","class":"temp-input"}).css({display:"none",position:"absolute"}).change(function(){if(this.files&&this.files[0]){var t=new FileReader;t.onload=function(t){tinymce.activeEditor.execCommand("insertHTML",!1,'<img class="inline-img" src="'+t.target.result+'" width="80%" >'),tinymce.activeEditor.uploadImages()},t.readAsDataURL(this.files[0])}$(".temp-input").remove()});$("body").append(t),t.click()}),$("#input-date").val(GetCurrentDate()),$("#btn-att").click(function(){o.atts.push(i.addAtt())}),$("#btn-upload").click(function(){$("#loader").modal("show");var n=$("#loader").find(".loader");n.text("uploading Images"),tinymce.activeEditor.uploadImages(function(a){n.text("wrapping together");var l=i.wrapUp(o.atts);data={title:$("#input-title").val(),date:$("#input-date").val(),source:$("#input-source").val(),cover:$(tinymce.activeEditor.save()).find("img").attr("src"),quote:getQuoteText(tinymce.activeEditor.save()),body:tinymce.activeEditor.save()+l,att:l},e&&(data.id=e),n.text("uploading");var s="/add_"+t;$.post(s,data,function(t){$("#loader").modal("hide"),e?document.location.reload(!0):window.location=t.url})})})}}function GetCurrentDate(){var t=new Date,e=t.getMonth()<9?"0"+(t.getMonth()+1):t.getMonth()+1,i=t.getFullYear()+"-"+e+"-"+t.getDate();return i}function getQuoteText(t){var e="";return $(t).find("*").each(function(){return $(this).text().length>32?(e=$(this).text(),!1):void 0}),e}$(document).ready(function(){"/"==window.location.pathname&&Cookies.remove("editmode"),$(".edit-controls")&&$(".edit-controls")[0]&&Cookies.set("editmode","right on",{expires:1}),console.log(111),$(".edit-logo").click(uploadLogo),$("#sidebar-hidden").find(".item.nav-link").click(function(){$(".sidebar").sidebar("hide")}),$(".content-module").each(function(t,e){checkVisible(e)&&$(e).addClass("already-visible")}),showScrollTop(),$(document).scroll(function(){showScrollTop(),scrollStatus.recordScroll()}),$("#app-r")&&$("#app-r")[0]&&initRefe(),$(".carousel-fade").carousel({interval:8e3})});var scrollStatus={scrollRecord:[0,0],init:function(){scrollStatus.setPosition()},setPosition:function(){scrollStatus.position=$(window).scrollTop()},recordScroll:function(){scrollStatus.scrollRecord[1]=scrollStatus.scrollRecord[0],scrollStatus.scrollRecord[0]=$(window).scrollTop()>scrollStatus.position?-1:1,scrollStatus.position=$(window).scrollTop(),scrollStatus.direction=-1===scrollStatus.scrollRecord[0]?"down":"up",scrollStatus.continuous=scrollStatus.scrollRecord[0]===scrollStatus.scrollRecord[1]},adaptResize:function(){scrollStatus.init()}};$(document).ready(scrollStatus.init),$(window).resize(scrollStatus.adaptResize),$(".edit-controls").each(function(){var t=this,e=$(this);if($(this).find(".save-btn").hide(),"publication"==e.data("type")){var i=(e.parent(".publication"),$(this).parent().find(".edit-only"));$(this).find(".edit-btn").click(function(){$(t).find(".edit-btn").hide(),$(t).find(".save-btn").show(),i.css("display","inline-block"),i.prev(".edit-hidden").css("display","none"),$(t).find(".save-btn").click(function(){var e={id:$(t).data("id"),index:i.find(".att-index").val(),txt:i.find(".att-txt").val(),source:i.find(".att-source").val()};$.post("/add_publication",e,function(t){console.log(t),document.location.reload(!0)})})})}else if($(this).parent().find(".editable")&&$(this).parent().find(".editable")[0]){var i=$(this).parent().find(".editable");i.addClass("editing edit-disabled"),$(this).find(".edit-btn").click(function(){$(t).find(".edit-btn").hide(),$(t).find(".save-btn").show(),$(t).find(".save-btn").click(function(){var t={html:tinymce.activeEditor.save()};$.post("/change/"+e.data("type"),t,function(t){console.log(t),document.location.reload(!0)})});var o="#"+i.attr("id");i.removeClass("edit-disabled"),initMce(o)})}else if($(this).parent().find(".edit-only")&&$(this).parent().find(".edit-only")[0]){var i=$(this).parent().find(".edit-only");console.log(i),$(this).find(".edit-btn").click(function(){$(t).find(".edit-btn").hide(),$(t).find(".save-btn").show(),i.css("display","inline-block"),i.prev(".edit-hidden").css("display","none"),initUploadOf(e.data("type"),e.data("id"))})}$(this).find(".delete-btn").click(function(){$("#loader").modal("show");var t=$("#loader").find(".loader");t.text("ing!"),$.post("/delete",{_id:e.data("id"),doctype:e.data("type")},function(e){e.url?(t.text("done and done!"),window.location=e.url):(t.text("oops, failed...somehow"),$("#loader").modal("hide"),t.text("loading"))})})}),$(".add-btn").click(function(){var t=$("<div>").attr("class","expand-transition");$(this).append(t);var e=$(this).data("url"),i=$(this).data("type");$.get(e,function(e){$("#modal-cust").find(".container").html(e),$("#btn-cancel").click(function(){$("#body").show(),$("#modal-cust").hide("fast"),$("#modal-cust").find(".container").html("")}),$("#modal-cust").show("slow"),$("#body").hide("slow"),initUploadOf(i),t.remove(),$("#edit-pic").click(uploadPic)})});